{% extends "base.html" %}
{% load i18n %}
{% block extra_head %}
{% endblock %}
{% block content %}
<script type="text/javascript">
	<!--
	var media_url = 'rtmp://cloudpub.us/sip';
    
	// Get the Flash Movie by name, e.g., "video1" or "video2".
	function getFlashMovie(movieName) {
	    var isIE = navigator.appName.indexOf("Microsoft") != -1;
	    return (isIE) ? window[movieName] : document[movieName];
	}
    	
	var stream = "{{ request.user.username }}";

        function createChannel() {
		$.get( "/room/stream/" + stream + ":open", function( data ) {
			log("Channel created");
			Server.connect( "http://cloudpub.us:9000" );
                        Server.subscribe( stream, function( data ) {
				log("Server reply:" + data );
			});
		} );
    	}
    
	createChannel();
    
        // When VideoIO is created, and user has specified the name, start local video.
	function onCreationComplete(event) {
		var server = "cloudpub.us";
		var user = "{{ request.user.username }}@" + server;
		var authname = "{{ request.user.username }}";
		var authpass = "mypass";
		var displayname = "{{ request.user.first_name }} {{ request.user.last_name }}";
		var rate = 8;
		var rate_name = "narrowband";
		var url = "rtmp://" +server+ "/sip/" +user+ "?rate=" +rate+ "&bidirection=true"+ "&arg=" +authname+ "&arg=" +authpass+ "&arg=" +displayname+ "&arg=" +rate_name;
		alert( url );
		if (event.objectID == "video1") {
			getFlashMovie("video1").setProperty("src", url);
		}		
		if (event.objectID == "video2") {
		//	getFlashMovie("video2").setProperty("src", url);
		}		
	}

	// When local video's nearID is set, set our "src" property and initiate login.
	function onPropertyChange(event) {
		log( "PROPERY: "  + event.property );
		if (event.property == "src" && event.objectID == "video1") {
		}
	}

	function onCallback(event) {
		log( "NOTIFY: "  + event.method );
		if (event.method == "accepted") {
        		getFlashMovie('video1').setProperty('publish', 'local');
        		getFlashMovie('video1').setProperty('play', 'remote');
    		}
		if (event.method == "invited") {
			getFlashMovie('video1').callProperty('call', 'accept');
			//getFlashMovie('phone1').callProperty('call', 'reject', '486 Busy Here'); // to reject
    		}	 
	}

	function send() {
		var msg = document.getElementById("input").value;
		if (msg) {
			document.getElementById("input").value = "";
			log("INVITE: " + msg);
			getFlashMovie("video1").callProperty("call", "invite", msg );
			Server.send( stream, msg );
		}
	}
	
	// Write a message to the chat history text area.
	function log(msg) {
		var obj = document.getElementById("history");
		obj.value += (obj.value == "" ? "" : "\n") + msg; 
	}

	//-->
	</script>	
<div style="height: 500px;">
    <div style="position: absolute; left: 10px; top: 10px; width: 320px; height: 240px;">
		<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"
			id="video1" width="320" height="240"
			codebase="http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab">
			<param name="movie" value="{{ MEDIA_URL }}VideoIO.swf" />
			<param name="quality" value="high" />
			<param name="bgcolor" value="#000000" />
			<param name="allowFullScreen" value="true" />
			<param name="flashVars" value="controls=true&cameraQuality=80" />
			<param name="allowScriptAccess" value="always" />
			<embed src="{{ MEDIA_URL }}VideoIO.swf" quality="high" bgcolor="#000000"
				width="320" height="240" name="video1" align="middle"
				play="true" loop="false" quality="high"
				allowFullScreen="true"
				flashVars="controls=true&cameraQuality=80"
				allowScriptAccess="always"
				type="application/x-shockwave-flash"
				pluginspage="http://www.adobe.com/go/getflashplayer">
			</embed>
		</object>
    </div>
    <div style="position: absolute; left: 10px; top: 260px; width: 320px; height: 240px;">
		<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"
			id="video2" width="320" height="240"
			codebase="http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab">
			<param name="movie" value="{{ MEDIA_URL }}VideoIO.swf" />
			<param name="quality" value="high" />
			<param name="bgcolor" value="#000000" />
			<param name="allowFullScreen" value="true" />
			<param name="flashVars" value="controls=true" />
			<param name="allowScriptAccess" value="always" />
			<embed src="{{ MEDIA_URL }}VideoIO.swf" quality="high" bgcolor="#000000"
				width="320" height="240" name="video2" align="middle"
				play="true" loop="false" quality="high"
				allowFullScreen="true"
				allowScriptAccess="always"
				flashVars="controls=true"
				type="application/x-shockwave-flash"
				pluginspage="http://www.adobe.com/go/getflashplayer">
			</embed>
		</object>
    </div>

	<div style="position: absolute; left: 340px; top: 10px; width: 320px; height: 490px;">
		<div style="float: right; height: 18px;">
			<div id="local" style="float: left;"></div>
		</div>
		<textarea id="history" autocomplete="off"
			style="width: 320px; height: 410px;"></textarea>
		<br/>
		Enter your text message: 
		<input id="input" type="text" autocomplete="off"
			style="width: 320px; height: 24px;"
			onkeypress="javascript: if ((event.keyCode || event.which) == 13) { send(); return false; }"/>
			
		<div style="float: right; height: 18px;">
			<div id="remote" style="float: left;">You are not connected</div> &nbsp; |
			<a href="#" onclick="javascript: login(true); return false;">Next Person in this category</a>
		</div> 
	</div>
</div>

{% endblock %}
{% block sidebar %}
<div class="box">
Conferencing goes here
</div>
{% endblock %}
{% block initscript %}
{% endblock %}

